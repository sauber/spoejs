<h1>Spoejs channels at this site:</h1>
% foreach my $chan ( @channels ) {
<a href="/<% $chan->channel_dir() %>/index.html">
<h2><% $chan->get( 'title' ) %></h2>
</a>

% if ( $chan->{S} ) {
% $spoejs{channel_path} = $chan->{path};
% $spoejs{channel} = $chan->channel_dir();
<& /w, w => 'abstract', storyref => $chan->{S} &>
% } else {
No stories.
% }
<br/>
<br/>
<br/>
% }
<hr/>
Administration:
<br/>
<a href="/htm/admin/siteconfig.html">
Site configuration
</a>
<%init>
use Date::Manip;
my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/",
                                  lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $CL->{msg} if $CL->{msg};
my $SC = new Spoejs::SiteConf( path => "$ENV{DOCUMENT_ROOT}/../lib",
                               lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $SC->{msg} if $SC->{msg};
my $policy = $SC->get( 'policy' );

# Gives array of ChannelConf object refs
my @channels = $CL->search_channels() unless $CL->{msg};
@channels = () if ( $channels[0] eq undef );

# Sort channels by date of newest entry
for ( @channels ) {
  my $SL = new Spoejs::StoryList( lang => $spoejs{lang_handle},
                                  path => $_->{path} );
  my @s = $SL->list_stories( count => 1 );

  # Add date in seconds since epoch
  $_->{newest_date} = $s[0] ? UnixDate($s[0]->get( 'date' ), "%s") : 0;

  # Add story reference for later use
  $_->{S} = $s[0] if $s[0];
}

warn Dumper @channels;
# Sort based on date in seconds
@channels = sort { $b->{newest_date} <=> $a->{newest_date} } @channels;
</%init>
