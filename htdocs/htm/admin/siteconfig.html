<h1>Status for channels at this site:</h1>
<& /w, w => "login", action => '', ses_var => 'siteauth' &>
% return unless ( $session{siteauth} );
<form method="post" action="">
<table width="100%">
<tr>
<th>Shortname</th><th>Title</th><th>Public</th>
<th>Active</th><th>Archive</th><th>Delete</th>
</tr>
% foreach my $chan ( @channels ) {
<tr>
<td><% $chan->get( 'shortname' ) %></td>
<td><a href="/<% $chan->channel_dir() %>/index.html">
<% $chan->get( 'title' ) %></a>
</td>
<td align="center"><% $chan->get( 'public' ) %></td>
<td align="center">
<select name="<% $chan->get( 'shortname' ) %>">
% while ( my ( $k, $v ) = each %yn ) {
<option value="<% $k %>"\
<% $chan->get( 'active' ) eq $k ? ' selected="selected">' : '>' %>
<%$v %>
</option>
% }
</select>
</td>
%# Archive
<td>
<input type="submit" name="archive" value="<% $chan->get( 'shortname' ) %>"/>
</td>
%# Delete
<td>
<input type="submit" name="delete" value="<% $chan->get( 'shortname' ) %>"/>
</td>
</tr>
% }
</table>
<br/>
Site policy:
<select name="policy">
% foreach my $pol ( sort keys %policy ) {
 <option value="<% $pol %>"\
<% $SC->get( 'policy' ) eq $pol ? ' selected="selected">' : '>' %>\
<%$policy{$pol}%></option>
% }
</select>
<br/>
<br/>
New username:
<input type="text" name="newusername" value="<%$session{siteauth}%>"/>
<br/>
<br/>
New password:
<input type="password" name="newpassword1"/>
% # Add password verification
%#<br/>
%#<br/>
%#<input type="text" name="newpassword2"/>
<br/>
<br/>
<input type="submit" name="submit" value="Submit" />
</form>
<a href="/htm/admin/signup.html">
Add a new spoejs channel
</a>
<%init>

my %yn = ( yes => 'Yes', no => 'No' );

my %policy = ( ffa => 'Free-for-all', signup => 'Signup-Approve',
               invite => 'Invite-only' );

my $SC = new Spoejs::SiteConf( path => "$ENV{DOCUMENT_ROOT}/../lib",
                               lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $SC->{msg} if $SC->{msg};

if ( $ARGS{login} ) {

  my $p = $SC->get( 'password' );
  my $u = $SC->get( 'username' );
  $session{siteauth} = $ARGS{username} 
                            if $ARGS{username} eq $u and $ARGS{password} eq $p;

} elsif ( $ARGS{logout} ) {

  delete $session{siteauth};
}

my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/",
                                  lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $CL->{msg} if $CL->{msg};

# Delete and archive before getting channel list
if ( $ARGS{delete} ) {

  $CL->delete_channel( $ARGS{delete} ) or warn $CL->{msg};
}

if ( $ARGS{archive} ) {

  $CL->archive_channel( $ARGS{archive} );
}

# Get array of ChannelConf object refs
my @channels;
@channels = $CL->search_channels();
@channels = () if $channels[0] eq undef;

# Set the new status
if ( $ARGS{submit} ) {

  foreach my $chan ( @channels ) {
    $chan->set( active => $ARGS{$chan->get('shortname')} );
  }

  # Set new policy
  $SC->set( policy => $ARGS{policy} ) or warn $SC->{msg};

  # Set new user/pass
  $SC->set( username => $ARGS{newusername} ) if $ARGS{newusername};
  $SC->set( password => $ARGS{newpassword1} ) if $ARGS{newpassword1};
}
</%init>
