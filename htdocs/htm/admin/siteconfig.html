%# Site configuration
%#
%# License: Artistic License
%#          http://www.opensource.org/licenses/artistic-license.php
%#
%# $Id: siteconfig.html,v 1.9 2004/05/06 05:56:06 snicki Exp $
%#
<h1><&|/l&>statuschannel</&>:</h1>
<& /w, w => "login", action => '', ses_var => 'siteauth' &>
% return unless ( $session{siteauth} );
<form method="post" action="">
<table width="100%">
<tr>
<th><&|/l&>shortname</&></th><th>Title</th><th><&|/l&>public</&></th>
<th><&|/l&>active</&></th><th><&|/l&>archive</&></th><th><&|/l&>delete</&></th>
</tr>
% foreach my $chan ( @channels ) {
<tr>
<td><% $chan->get( 'shortname' ) %></td>
<td><a href="/<% $chan->channel_dir() %>/index.html">
<% $chan->get( 'title' ) %></a>
</td>
<td align="center"><% $chan->get( 'public' ) %></td>
<td align="center">
<select name="<% $chan->get( 'shortname' ) %>">
% for my $k ( qw( yes no_ ) ) {
<option value="<% $k %>"\
<% $chan->get( 'active' ) eq $k ? ' selected="selected">' : '>' %>
<&|/l&><% $k %></&>
</option>
% }
</select>
</td>
%# Archive
<td>
<input type="submit" name="archive" value="<% $chan->get( 'shortname' ) %>"/>
</td>
%# Delete
<td>
<input type="submit" name="delete" value="<% $chan->get( 'shortname' ) %>"/>
</td>
</tr>
% }
</table>
<br/>
<&|/l&>sitepolicy</&>:
<select name="policy">
% foreach my $pol ( @policy ) {
 <option value="<% $pol %>"\
<% $SC->get( 'policy' ) eq $pol ? ' selected="selected">' : '>' %>\
<&|/l&><%$pol%></&></option>
% }
</select>
<br/>
<br/>
<&|/l&>new_username</&>:
<input type="text" name="newusername" value="<%$session{siteauth}%>"/>
<br/>
<br/>
<&|/l&>newpass</&>:
<input type="password" name="newpassword1"/>
% # Add password verification
%#<br/>
%#<br/>
%#<input type="text" name="newpassword2"/>
<br/>
<br/>
<select name="<% $transopt %>">
% for my $k ( qw( yes no_ ) ) {
<option value="<% $k %>"\
<% $SC->get( $transopt ) eq $k ? ' selected="selected">' : '>' %>
<&|/l&><% $k %></&>
</option>
% }
</select>
<br/>
<br/>
<input type="submit" name="submit" value="<&|/l&>submit</&>" />
</form>
<a href="/htm/admin/signup.html">
<&|/l&>addnewchannel</&>
</a>
<%init>
my $transopt = 'showtranslationoptions';
my @policy = qw( freeall signup_approve inviteonly );

my $SC = new Spoejs::SiteConf( path => "$ENV{DOCUMENT_ROOT}/../lib",
                               lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $SC->{msg} if $SC->{msg};

if ( $ARGS{login} ) {

  my $p = $SC->get( 'password' );
  my $u = $SC->get( 'username' );
  $session{siteauth} = $ARGS{username} 
                            if $ARGS{username} eq $u and $ARGS{password} eq $p;

} elsif ( $ARGS{logout} ) {

  delete $session{siteauth};
}

my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/",
                                  lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $CL->{msg} if $CL->{msg};

# Delete and archive before getting channel list
if ( $ARGS{delete} ) {

  $CL->delete_channel( $ARGS{delete} ) or warn $CL->{msg};
}

if ( $ARGS{archive} ) {

  $CL->archive_channel( $ARGS{archive} );
}

# Get array of ChannelConf object refs
my @channels;
@channels = $CL->search_channels();
@channels = () if $channels[0] eq undef;

# Set the new status
if ( $ARGS{submit} ) {

  foreach my $chan ( @channels ) {
    $chan->set( active => $ARGS{$chan->get('shortname')} );
  }

  # Set new policy
  $SC->set( policy => $ARGS{policy} ) or warn $SC->{msg};

  # Set new user/pass
  $SC->set( username => $ARGS{newusername} ) if $ARGS{newusername};
  $SC->set( password => $ARGS{newpassword1} ) if $ARGS{newpassword1};

  # Set transoptions
  $SC->set( $transopt => $ARGS{$transopt} );
}
</%init>
