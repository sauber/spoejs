%# Insert or edit story
%#
%# License: Artistic License
%#          http://www.opensource.org/licenses/artistic-license.php
%#
%# $Id: story.html,v 1.17 2004/04/09 18:06:42 sauber Exp $
%#
% return unless $m->comp( 'checkLogin.html' );
<& /js/confirm.js &>
% if ( $ARGS{submit} ) {
<h4>Story saved successfully.</h4>
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/upload.html", 
                             d=>$story_dir &>">
Add media to story.
</a>
% return; }

% if ( $ARGS{delete} ) {
<h4>Story deleted successfully.</h4>
<a href="/<% $spoejs{channel} %>/index.html">
Go to channel home.
</a>
% return; }


<h3><&|/l&>edit_lang</&>: <&|/l&><% $cur_lang %></&></h3>

<form action="" method="post">
<table width="500"><tr><td>
<fieldset><legend>Please fill out this form:</legend>
<&|/l&>yourname</&>:<br/>
<input type="text" size="60" name="author" value="<%$ARGS{author}%>"/><br/>
<&|/l&>storytitle</&>:<br/>
<input type="text" size="60" name="title" value="<%$ARGS{title}%>"/><br/>
<&|/l&>date</&>: <&|/l&>blank_default</&><br/>
<input type="text" size="60" name="date" value="<%$ARGS{date}%>"/><br/>
<&|/l&>category</&>:<br/>
<select name="category">
<option value="">Please select</option>
% foreach my $cat ( sort keys %categories ) {
% my $selected = $cat eq $ARGS{category} ? ' selected="selected"' : '';
<option value="<% $cat %>"<% $selected %>><% $cat %></option>
% }
</select>
<&|/l&>or_new</&>: 
<input type="text" size="30" name="newcategory" value=""/><br/>
<&|/l&>story_abstract</&>:<br/>
<textarea name="abstract" rows="5" cols="60"><%$ARGS{abstract}%></textarea>
<br/>
<&|/l&>full_story</&>:<br/>
<textarea name="fulltext" rows="20"
cols="60"><%$ARGS{fulltext}%></textarea>
<br/>
<br/>
% if ( $story_dir ) {
<&|/l&>thumbnail</&>:<br/>
%# XXX: simplify %thumb to array as hash-keys is used as lang-key
% for ( sort keys %thumb ) {
<&|/l&><%$_%></&>: <input type="radio" name="thumbnail" value="<% $_
%>" <% $checked{$_} %>/>
% }
<select name="thumbfile">
  <option value=""><&|/l&>choose</&></option>
% for ( $S->media_list() ) {
% my $c = $checked_file eq $_->{file} ? ' selected="selected"' : '';
  <option value="<%$_->{file}%>"<% $c %>><% $_->utf_filename() %></option>
% }
</select>
<br/>
<br/>
% }
</fieldset>
<input type="submit" name="submit" value="<&|/l&>submit</&>"/>
<input type="submit" name="delete" value="<&|/l&>delete</&>" onclick="return confirmSubmit()"/>
</td></tr></table>
</form>
% if ( $story_dir ) {
<h4><&|/l&>media_man</&>:</h4>
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/upload.html", 
                             d =>$story_dir &>">
<&|/l&>add</&>
</a>
&nbsp;&nbsp;
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/rename.html", 
                              d=>$story_dir &>">
<&|/l&>edit</&>
</a>
% }
<%init>
my %thumb = ( first => 'First', last => 'Last', random => 'Random',
specific => 'Specific' );
my $cur_lang = $spoejs{lang_handle}->{lang_order}->[0];
my @entries = qw( title date category abstract fulltext author thumbnail );

my $story_dir = $spoejs{p}{d} || undef;
my $S;
my %checked;
my $checked_file;

# Get data from existing story or create new story
if ( $spoejs{p}{d} && -d "$spoejs{channel_path}/$spoejs{p}{d}" && !$ARGS{submit} ) {

  $S = new Spoejs::Story( path => "$spoejs{channel_path}/$spoejs{p}{d}",
                          lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $S->{msg} if $S->{msg};

  # Add data to args
  %ARGS = ( %ARGS, $S->get() );

  # Find thumbtype for html 'checked'ing
  for ( keys %thumb ) {
    $checked{$_} = $_ eq $ARGS{thumbnail} ? ' checked="checked"' : '';
  }
  $checked_file = $ARGS{thumbnail} if ! defined $thumb{$ARGS{thumbnail}};
  $checked{specific} = ' checked="checked"' if ! defined $thumb{$ARGS{thumbnail}};

}


if ( $ARGS{submit} ) {

  # Get thumbnail
  $ARGS{thumbnail} = $ARGS{thumbfile} if $ARGS{thumbnail} eq 'specific';

  # Create new story if necessary
  unless ( $story_dir && -d "$spoejs{channel_path}/$story_dir" ) {
    use Date::Manip;
    $ARGS{date} ||= Date::Manip::UnixDate( "today", "%b %d %Y %H:%M" );
    $story_dir = $spoejs{SL}->add_story( date => $ARGS{date} );
  }

  $S = new Spoejs::Story( path => "$spoejs{channel_path}/$story_dir",
                          lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $S->{msg} if $S->{msg};

  # XXX: Verify input
  $ARGS{category} = $ARGS{newcategory} if $ARGS{newcategory};

  # Save to story
  my %new_data;
  for ( @entries ) {
    $new_data{$_}{$cur_lang} = $ARGS{$_};
  }

  $S->set( %new_data );
}

if ( $ARGS{delete} ) {
  $spoejs{SL}->del_story( story => $story_dir );
}

# Used for category chooser - counts ignored
my %categories = $spoejs{SL}->count_stories( by => 'category' );
</%init>
