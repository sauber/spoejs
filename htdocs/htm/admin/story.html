%# Insert or edit story
%#
%# License: Artistic License
%#          http://www.opensource.org/licenses/artistic-license.php
%#
%# $Id: story.html,v 1.28 2004/06/13 02:43:24 snicki Exp $
%#
% return undef unless $m->comp( '/htm/login.html:check_login' );
<& /js/confirm.js &>
% if ( $ARGS{submit} ) {
<h4>**storysave**.</h4>
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/upload.html", 
                             d=>$story_dir &>">
**addmediastory**.
</a>
% return; }

% if ( $ARGS{delete} ) {
<h4>Story deleted successfully.</h4>
<a href="/<% $spoejs{channel} %>/index.html">
Go to channel home.
</a>
% return; }

<h3>**edit_lang**: **<% $cur_lang %>**</h3>
<div style="float: left;">
<table width="100%">
<tr><td width="490">
<form action="" method="post">
<fieldset><legend>**please_fill_out_this_form**</legend>
**yourname**:<br/>
<input type="text" size="60" name="author" value="<%$ARGS{author}%>"/><br/>
**storytitle**:<br/>
<input type="text" size="60" name="title" value="<%$ARGS{title}%>"/><br/>
**date**: **blank_default**<br/>
<input type="text" size="60" name="date" value="<%$ARGS{date}%>"/><br/>
**category**:<br/>
<select name="category">
<option value="">Please select</option>
% foreach my $cat ( sort keys %categories ) {
% my $selected = $cat eq $ARGS{category} ? ' selected="selected"' : '';
<option value="<% $cat %>"<% $selected %>><% $cat %></option>
% }
</select>
**or_new**: 
<input type="text" size="30" name="newcategory" value=""/><br/>
**story_abstract**:<br/>
<textarea name="abstract" rows="5" cols="60"><%$ARGS{abstract}%></textarea>
<br/>
**full_story**:<br/>
<textarea name="fulltext" rows="20" cols="60" id="fulltext">
<%$ARGS{fulltext}%></textarea>
<br/>
<br/>
% if ( defined $spoejs{Story} ) {
**thumbnail**:<br/>
% for my $i ( @thumb ) {
**<% $i %>**: <input type="radio" name="thumbnail" value="<% $i
%>" <% $checked{$i} %>/> 
% }
<select name="thumbfile">
  <option value="">**choose**</option>
% for ( $spoejs{Story}->media_list() ) {
% my $c = $checked_file eq $_->{file} ? ' selected="selected"' : '';
  <option value="<%$_->{file}%>"<% $c %>><% $_->utf_filename() %></option>
% }
</select>
<br/>
<br/>
% }
<input type="submit" name="submit" value="**submit**"/>&nbsp;
<input type="submit" name="delete" value="**delete**" onclick="return confirmSubmit()"/>
</fieldset>
</form>
% if ( defined $spoejs{Story} ) {
<h4>**media_man**:</h4>
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/upload.html", 
                             d =>$story_dir &>">
**add**
</a>
&nbsp;&nbsp;
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/rename.html", 
                              d=>$story_dir &>">
**rename_delete**
</a>
&nbsp;&nbsp;
<a href="<& /htm/url:encode, "/$spoejs{channel}/admin/annotations.html", 
                              d=>$story_dir &>">
**annotations**
</a>
</td><td valign="top">
<&| /w, w => 'box', heading => '**click_insert_image**' &>
<iframe src="<& /htm/url:encode, "/$spoejs{channel}/admin/mediapicker.html", 
        d=>$story_dir &>" width="100%" height="620" frameborder="1">
[Your user agent does not support frames or is currently configured
not to display frames.]
</iframe>
</&>
</td></tr></table>
</div>
% }
<br clear="all"/>
<pre>
<% Dumper $spoejs{ARGS} %>
<% Dumper \%session %>
</pre>
<%init>
my @thumb = qw( first last random always_random specific );
my $cur_lang = $spoejs{current_language};
my @entries = qw( title date category abstract fulltext author thumbnail );

my $story_dir = $spoejs{p}{d} || undef;
my %checked;
my $checked_file;

# Get data from existing story or create new story
if ( defined $spoejs{Story} && !$ARGS{submit} ) {

  # Add data to args
  %ARGS = ( %ARGS, $spoejs{Story}->get() );

  # Find thumbtype for html 'checked'ing
  for ( @thumb ) {
    $checked{$_} = $_ eq $ARGS{thumbnail} ? ' checked="checked"' : '';
  }
  $checked_file = $ARGS{thumbnail} unless grep {$_ eq
  $ARGS{thumbnail}} @thumb ;
  $checked{specific} = ' checked="checked"'  unless grep {$_ eq
  $ARGS{thumbnail}} @thumb ;

}

if ( $ARGS{submit} ) {

  # Get thumbnail
  $ARGS{thumbnail} = $ARGS{thumbfile} if $ARGS{thumbnail} eq 'specific';

  # XXX: Verify input
  $ARGS{category} = $ARGS{newcategory} if $ARGS{newcategory};

  # Save to story
  my %new_data;
  for ( @entries ) {
    $new_data{$_}{$cur_lang} = $ARGS{$_};
  }

  # Create new story if necessary
  if ( defined $spoejs{Story} ) {
    $spoejs{Story}->set( %new_data );
  } else {
    use POSIX qw(strftime);
    $new_data{date}{$cur_lang} ||= strftime "%F", localtime time();
    $story_dir = $spoejs{SL}->add_story( date => $new_data{date}{$cur_lang} );
    die "Could not create new story" unless length $story_dir > 8;
    my $S = new Spoejs::Story( lang => $spoejs{lang_handle},
                               path => "$spoejs{channel_path}/$story_dir" );
    $spoejs{error}{$m->current_comp->source_file} = $S->{msg} 
                                                      if $S->{msg};
    $S->set( %new_data );
  }

}

# Delete story if so told
$spoejs{SL}->del_story( story => $story_dir ) if ( $ARGS{delete} );

# Used for category chooser - counts ignored
my %categories = $spoejs{SL}->count_stories( by => 'category' );
</%init>
