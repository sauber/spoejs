<%doc>
Insert or edit story

License: Artistic License
         http://www.opensource.org/licenses/artistic-license.php

$Id: story.html,v 1.35 2004/06/23 09:05:54 bottle18 Exp $
</%doc>
% return undef unless $m->comp( '/htm/login.html:check_login' );
%if ( defined $spoejs{p}{d} ) {
<& /htm/admin/story_tab.mas &>
%}
% if ( $ARGS{submit} ) {
<h4>**storysave**.</h4>
% return; }

<h3>**edit_lang**: **<% $cur_lang %>**</h3>
<fieldset><legend>**story_details**</legend>
<form action="" method="post">
**yourname**:<br/>
<input type="text" size="60" name="author" value="<%$ARGS{author}%>"/><br/>
<br/>
**storytitle**:<br/>
<input type="text" size="60" name="title" value="<%$ARGS{title}%>"/><br/>
<br/>
**date**: **blank_default**<br/>
<input type="text" size="60" name="date" value="<%$ARGS{date}%>"/><br/>
<br/>
**category**:<br/>
<select name="category">
<option value="">Please select</option>
% foreach my $cat ( sort keys %categories ) {
% my $selected = $cat eq $ARGS{category} ? ' selected="selected"' : '';
<option value="<% $cat %>"<% $selected %>><% $cat %></option>
% }
</select>
**or_new**: 
<input type="text" size="30" name="newcategory" value=""/><br/>
<<<<<<< story.html
**story_summary**:<br/>
<textarea name="abstract" rows="5" cols="60"><%$ARGS{abstract}%></textarea>
=======
<br/>
**story_abstract**:<br/>
<textarea name="abstract" rows="5" cols="80"><%$ARGS{abstract}%></textarea>
<br/>
>>>>>>> 1.33
<br/>
**full_story**:<br/>
<textarea name="fulltext" rows="20" cols="80" id="fulltext">
<%$ARGS{fulltext}%></textarea>
<br/>
<br/>
% if ( defined $spoejs{Story} ) {
**thumbnail**:<br/>
**journal_default**: <input type="radio" name="thumbnail" value="default" <% $checked{default} %>/> 
**specific**: <input type="radio" name="thumbnail" value="specific" <% $checked{specific} %>/> 
<select name="thumbfile">
  <option value="">**choose**</option>
% for ( $spoejs{Story}->media_list() ) {
% my $c = $checked_file eq $_->{file} ? ' selected="selected"' : '';
  <option value="<%$_->{file}%>"<% $c %>><% $_->utf_filename() %></option>
% }
</select>
<br/>
<br/>
% }
<input type="submit" name="submit" value="**submit**"/>&nbsp;
</form>
</fieldset>
<%init>
my $cur_lang = $spoejs{current_language};
my @entries = qw( title date category abstract fulltext author thumbnail );

my $story_dir = $spoejs{p}{d} || undef;
my %checked;
my $checked_file;

# Get data from existing story or create new story
if ( defined $spoejs{Story} && !$ARGS{submit} ) {

  # Add data to args
  %ARGS = ( %ARGS, $spoejs{Story}->get() );

  # Join paragraphs of text
  for my $k ( keys %ARGS ) {
    warn "read $k which is " . ref($ARGS{$k});
    if ( ref($ARGS{$k}) eq "ARRAY" ) {
      $ARGS{$k} = join "\n\n", @{$ARGS{$k}};
    }
  }

  # Find thumbtype for html 'checked'ing
  for ( qw( default specific ) ) {
    $checked{$_} = $_ eq $ARGS{thumbnail} ? ' checked="checked"' : '';
  }

  if ( defined $ARGS{thumbnail} and !($ARGS{thumbnail} eq 'default')) {
    $checked_file = $ARGS{thumbnail};
    $checked{specific} = ' checked="checked"';
  } else {
    $checked{default} =  ' checked="checked"';
  }
}

if ( defined $ARGS{submit} ) {

  # Get thumbnail
  $ARGS{thumbnail} = $ARGS{thumbfile} if $ARGS{thumbnail} eq 'specific';

  # XXX: Verify input
  $ARGS{category} = $ARGS{newcategory} if $ARGS{newcategory};

  # Save to story
  my %new_data;
  for ( @entries ) {

    # Clean up in newlines:
    $ARGS{$_} =~ s/\r\n/\n/mg;

    # Check for multiple paragraphs
    if ( $ARGS{$_} =~ /\n\n/ ) {
      $new_data{$_}{$cur_lang} = [ split /\n\s*\n/, $ARGS{$_} ];
    } else {
      $new_data{$_}{$cur_lang} = $ARGS{$_};
    }
  }

  # Create new story if necessary
  if ( defined $spoejs{Story} ) {
    $spoejs{Story}->set( %new_data );
  } else {
    use POSIX qw(strftime);
    $new_data{date}{$cur_lang} ||= strftime "%F", localtime time();
    $story_dir = $spoejs{SL}->add_story( date => $new_data{date}{$cur_lang} );
    die "Could not create new story" unless length $story_dir > 8;
    my $S = new Spoejs::Story( lang => $spoejs{lang_handle},
                               path => "$spoejs{channel_path}/$story_dir" );
    $spoejs{error}{$m->current_comp->source_file} = $S->{msg} if $S->{msg};
    $S->set( %new_data );
  }
}

# Used for category chooser - counts ignored
my %categories = $spoejs{SL}->count_stories( by => 'category' );
</%init>
