%# Register channel or edit configuration
%#
%# License: Artistic License
%#          http://www.opensource.org/licenses/artistic-license.php
%#
%# $Id: channelform.html,v 1.37 2004/06/04 08:40:18 snicki Exp $
%#
%if ( $ARGS{submit} && keys %errs == 0 && $spoejs{channel} ) {
<h2><&|/l&>congrat_changes</&></h2>
<a href="/<%$ARGS{shortname}%>/index.html"><&|/l&>click_continue</&></a>
% } elsif ( $ARGS{submit} && keys %errs == 0 ) {
<h2><&|/l&>congrat_signup</&></h2>
<h3><a href="/<%$ARGS{shortname}%>/index.html"><&|/l&>click_channel</&></a>
<br/>
<a href="/<%$ARGS{shortname}%>/admin/story.html"><&|/l&>or_add_newstory</&></a>
</h3>
% } else {
% return unless check_cred( $policy );
% unless ( defined $spoejs{channel} ) {
<h2>
<&|/l&>signup_newjournal</&>
</h2>
% }
<form method="post">
<fieldset>
<legend>
<&|/l&>account_signup</&>
</legend>
<table>
%if ( keys %errs > 0 ) {
<tr><td colspan="3" class="form_error">**probs_in_reg**:</td></tr>
% for my $err (values %errs) {
<tr><td colspan="3" class="form_error"> - <% $err %></td></tr>
%}
<tr><td colspan="3" class="form_error">**fix_and_resubmit**</td></tr>
<tr><td colspan="3" class="form_error"><hr/></td></tr>
%}
<% form_row( 'username',  'username', "text", $ARGS{'username'},
             $errs{'username'}, 16 ) %>
<% form_row( "passwd", "password", "password", $ARGS{password},
             $errs{password}, 16 ) %> 
<% form_row( "passwd_retype", "password2", "password", "",
$errs{password}, 16) %>
<tr>
<td>&nbsp;</td>
</tr>
<tr>
% my $jour_err_class = defined $errs{shortname} ? ' class="form_error"' : '';
<td<%$jour_err_class%>>**journal_id**:</td>
  <td><input value="<%$ARGS{'shortname'}%>" type="text"
             name="shortname" size="16" maxlength="16"></td>
  <td class="form_desc">**journal_id_description** http://<%
  $ENV{SERVER_NAME} %>/&lt;**journal_id**&gt;</td>
</tr>
<% form_row( 'title',  'title', "text", $ARGS{'title'},
             $errs{'title'}, 30 ) %>
<% form_row( 'description', 'description', "text", $ARGS{'description'},
              $errs{'description'}, 50 ) %>
<tr>
<td>**language**:</td>
<td>
<& /w, w => 'langselect' &>
</td>
<td class="form_desc">**language_description**</td>
</tr>
<tr>
<td>**theme**:</td>
<td>
<& /w, w => 'themeselect' &>
</td>
<td class="form_desc">**theme_description**</td>
</tr>
<tr>
<td>**journal_security**:</td>
<td>
% my $yc = $ARGS{public} eq 'yes' ? ' checked="checked"' : '';
% my $nc = $ARGS{public} eq 'no_' ? ' checked="checked"' : '';
% $yc = ' checked="checked"' unless $yc or $nc;
**public**: <input type="radio" name="public" value="yes"<% $yc %>>
**private**: <input type="radio" name="public" value="no_"<% $nc %>>
</td>
<td class="form_desc">**journal_security_description**</td>
</tr>
</table>
</fieldset>
<br/>
<input type="submit" name="submit" value="**submit**"/>
</form>
%}
<%init>
  my $cur_lang = $spoejs{current_language};

  my @localize = qw ( title description );
  my @no_local = qw( username shortname language password public );
  my %errs;
  my $SC = new Spoejs::SiteConf( path => "$ENV{DOCUMENT_ROOT}/../lib",
                                 lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $SC->{msg} if $SC->{msg};

  my $policy = $SC->get( 'policy' );

# Load data if channel exists
if ( -d $spoejs{channel_path} && !$ARGS{submit} )
{
  # XXX: What goes on when adding 'lang' here? (~nothing is returned in get()
  my $CC = new Spoejs::ChannelConf( path => $spoejs{channel_path},
                                    lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $CC->{msg} if $CC->{msg};

  %ARGS = ( %ARGS, $CC->get() );
}

if ( $ARGS{submit} ) {

  check_args( \%ARGS, \%errs );

  # Pick appropriate args from %ARGS
  my %cl_args;
  # No localization for these
  $cl_args{$_} = $ARGS{$_} for ( @no_local );
  $cl_args{$_}{$cur_lang} = $ARGS{$_} for ( @localize );

  # Add 'active' based on site policy
  $cl_args{active} = $policy eq 'signup_approve' ? 'no_' : 'yes';

  # Create new channel if there were no errors

  if ( keys %errs == 0 && !$spoejs{channel} ) {

    my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/" );

    my $res = $CL->new_channel( %cl_args );
    $spoejs{error}{new_chan} = $CL->{msg} unless $res;

    # Start as logged in when you have just signed up
    $session{chanauth}{$cl_args{shortname}} = 1;

  } elsif (  keys %errs == 0 && $spoejs{channel} ) {

    my $CC = new Spoejs::ChannelConf( path => $spoejs{channel_path},
                                      lang => $spoejs{lang_handle} );
    $spoejs{error}{$m->current_comp->source_file} = $CC->{msg} if $CC->{msg};

    my $res = $CC->set( %cl_args );
  }
}
</%init>
<%perl>
sub form_row {
  my ( $text, $name, $type, $val, $err, $size ) = @_;
  $size ||= 20;
  my $errclass = $err ? ' class="form_error"' : '';
  my $desc = "${text}_description"; #before text-change
  $text = "**$text**";
  return <<HTML;
<tr>
  <td$errclass>$text:</td>
  <td><input value="$val" type="$type" name="$name" size="$size"></td>
  <td class="form_desc">**$desc**</td>
</tr>
HTML
}

sub check_args {
  my ( $ARGS, $errs ) = @_;

  # XXX: Add checks on rest of input!!!
  unless ( $$ARGS{shortname} =~ /^[a-z]{4,16}$/ ) {
    $$errs{shortname} = "**invalid_journal_id**";
  }
  if ( -d "$ENV{DOCUMENT_ROOT}/users/$$ARGS{shortname}" and 
       ! defined $spoejs{channel} and ! defined $$errs{shortname} ) {
    $$errs{shortname} = " **journal_exists**";
  }
  unless ( $$ARGS{username} =~ /.{4,16}/ ) {
    $$errs{username} = "**invalid_username**";
  }
  unless ( length $$ARGS{password} > 3 ) {
    $$errs{username} = "**invalid_password**";
  }
  unless ( $$ARGS{password} eq $$ARGS{password2} ) {
    $$errs{password} = " **password_mismatch**";
  }
  unless ( length $$ARGS{title} > 1 ) {
    $$errs{title} = " **invalid_title**";
  }
  unless ( length $$ARGS{description} > 1 ) {
    $$errs{description} = " **invalid_description**";
  }
}

sub check_cred {
 my $policy = shift;
 if ( defined $spoejs{channel} ) {

   # We are editing current channel check if we are permitted
   return undef unless $m->comp( 'checkLogin.html' );

 } elsif (  $policy eq 'inviteonly' and !$session{siteauth} ) {

   # New channels can be made with siteauth creds or freall/signup_approve pol.
   return undef;
 }

  return 1;
}
</%perl>
