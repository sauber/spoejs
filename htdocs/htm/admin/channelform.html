<%doc>
Register channel or edit configuration

License: Artistic License
         http://www.opensource.org/licenses/artistic-license.php

$Id: channelform.html,v 1.44 2004/06/13 07:58:25 snicki Exp $
</%doc>
%if ( defined $ARGS{delete} ) {
<h2>**channel_deleted**</h2>
%return;
% }
%if ( defined $ARGS{submit} && !$error && $spoejs{channel} ) {
<h2>**congrat_changes**</h2>
<a href="/<%$ARGS{shortname}%>/index.html">**click_continue**</a>
% } elsif ( defined $ARGS{submit} && !$error ) {
<h2>**congrat_signup**</h2>
<h3><a href="/<%$ARGS{shortname}%>/index.html">**click_channel**</a>
<br/>
<a href="/<%$ARGS{shortname}%>/admin/story.html">**or_add_newstory**</a>
</h3>
% } else {
% return unless check_cred( $policy );  # Check unless authorized
<& /js/confirm.js &>
% unless ( defined $spoejs{channel} ) { # Are we editing existing channel
<h2>
**signup_newjournal**
</h2>
% }
<fieldset>
<legend>
**account_signup**
</legend>
<&| /htm/admin/fill_in_form.mas, data => \%ARGS, spec => $spec &>
<form name="channelform" method="post" action="">
<table>
<tr>
  <td>**username**:</td>
  <td><input type="text" name="username" size="16" maxlength="16"/></td>
  <td class="form_desc">**username_description**</td>
</tr>
<tr>
  <td>**passwd**:</td>
  <td><input type="password" name="password" size="16"/></td>
  <td class="form_desc">**passwd_description**</td>
</tr>
<tr>
  <td>**passwd_retype**:</td>
  <td><input type="password" name="password2" size="16"/></td>
  <td class="form_desc">**passwd_retype_description**</td>
</tr>
<tr>
<td>&nbsp;</td>
</tr>
<tr>
<td>**journal_id**:</td>
  <td><input type="text" name="shortname" size="16" maxlength="16"/></td>
  <td class="form_desc">
 **journal_id_description** http://<% $ENV{SERVER_NAME}%>/&lt;**journal_id**&gt;
  </td>
</tr>
<tr>
  <td>**title**:</td>
  <td><input type="text" name="title" size="30"/></td>
  <td class="form_desc">**title_description**</td>
</tr>
<tr>
  <td>**description**:</td>
  <td><input type="text" name="description" size="50"/></td>
  <td class="form_desc">**description_description**</td>
</tr>
<tr>
<td>**language**:</td>
<td>
<& /w, w => 'langselect' &>
</td>
<td class="form_desc">**language_description**</td>
</tr>
<tr>
<td>**theme**:</td>
<td>
<& /w, w => 'themeselect' &>
</td>
<td class="form_desc">**theme_description**</td>
</tr>
<tr>
<td>**journal_security**:</td>
<td>
% my $yc = $ARGS{public} eq 'yes' ? ' checked="checked"' : '';
% my $nc = $ARGS{public} eq 'no_' ? ' checked="checked"' : '';
% $yc = ' checked="checked"' unless $yc or $nc;
**public**: <input type="radio" name="public" value="yes"<% $yc %>/>
**private**: <input type="radio" name="public" value="no_"<% $nc %>/>
</td>
<td class="form_desc">**journal_security_description**</td>
</tr>
</table>
<br/>
<input type="submit" name="submit" value="**submit**"/>&nbsp;
<input type="submit" name="delete" value="**delete**" onclick="return confirmSubmit()"/>
</form>
</&>
</fieldset>
%}
<%init>
  my $cur_lang = $spoejs{current_language};

  # Setup error checking
  my $error;
  my $shortname_check = sub { my $data = shift;
              return ( -d "$ENV{DOCUMENT_ROOT}/users/$data->{shortname}" and 
                       !defined $spoejs{channel} and 
                       length $data->{shortname} > 0 ) ? 0 : 1; };

  my $password2_check = sub { my $data = shift; return ( $data->{password} eq
                                                      $data->{password2} ); };

  my $spec = { username    => { regexp      => '^.{4,16}$',
                                error       => '**invalid_username**' },
               shortname   => { regexp      => '^[a-z]{4,16}$',
                                error       => '**invalid_journal_id**',
	                        check       => $shortname_check,
                                error_check => '**journal_exists**' },
               title       => { regexp      => '.+',
	                        error       => '**invalid_title**' },
	       password    => { regexp      => '...+',
                                error       => '**invalid_password**' },
	       password2   => { check       => $password2_check,
                                error_check => '**password_mismatch**' },
               description => { regexp      => '.+',
                                error       => '**invalid_description**' },
              };

  # Define which variables can be localized 
  my @localize = qw ( title description );
  my @no_local = qw( username shortname language password public );

  # Get site signup policy
  my $policy = $spoejs{SiteConf}->get( 'policy' );

# Load data if channel exists
if ( -d $spoejs{channel_path} && ! defined $ARGS{submit} )
{
  %ARGS = ( %ARGS, $spoejs{ChannelConf}->get() );
}

# Process submission
if ( defined $ARGS{submit} ) {

  # Check for errors
  $error = $m->comp( '/htm/admin/error.mas:error_check', \%ARGS, $spec, 
                     'channelform' );

  # Pick appropriate args from %ARGS and ad language where appropriate
  my %cl_args;
  $cl_args{$_} = $ARGS{$_} for ( @no_local );
  $cl_args{$_}{$cur_lang} = $ARGS{$_} for ( @localize );

  # Add 'active' based on site policy
  $cl_args{active} = $policy eq 'signup_approve' ? 'no_' : 'yes';

  # Create new channel if there were no errors and we are not modifying
  if ( !$error && !$spoejs{channel} ) {

    my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/" );

    my $res = $CL->new_channel( %cl_args );
    $spoejs{error}{new_chan} = $CL->{msg} unless $res;

    # Start as logged in when you have just signed up
    $session{chanauth}{$cl_args{shortname}} = 1;

  } elsif (  !$error && $spoejs{channel} ) { # Modifying existing channel

    my $res = $spoejs{ChannelConf}->set( %cl_args );
  }
}

if ( defined $ARGS{delete} && defined $spoejs{channel} ) {
  my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/" );
  $CL->delete_channel( $spoejs{channel} ) or warn $CL->{msg};
  delete $session{chanauth}{$spoejs{channel}};
  delete $session{chanauth} unless keys %{$session{chanauth}};
}

</%init>
<%perl>
sub check_cred {
 my $policy = shift;
 if ( defined $spoejs{channel} ) {

   # We are editing current channel check if we are permitted
   return undef unless $m->comp( '/htm/login.html:check_login' );

 } elsif (  $policy eq 'inviteonly' and !$session{siteauth} ) {

   # New channels can be made with siteauth creds or freall/signup_approve pol.
   return undef;
 }

  return 1;
}
</%perl>
