%# Register channel or edit configuration
%#
%# License: Artistic License
%#          http://www.opensource.org/licenses/artistic-license.php
%#
%# $Id: channelform.html,v 1.18 2004/04/09 21:13:39 bottle18 Exp $
%#
%if ( $ARGS{submit} && keys %errs == 0 && $spoejs{channel} ) {
<h2><&|/l&>congrat_changes</&></h2>
<a href="/<%$ARGS{shortname}%>/index.html"><&|/l&>click_continue</&></a>
% } elsif ( $ARGS{submit} && keys %errs == 0 ) {
<h2><&|/l&>congrat_signup</&></h2>
<h3><a href="/<%$ARGS{shortname}%>/index.html"><&|/l&>click_channel</&></a>
<br/>
<a href="/<%$ARGS{shortname}%>/admin/story.html"><&|/l&>or _add_newstory</&></a>
</h3>
% } else {
% return unless check_cred( $policy );
<form method="post">
<fieldset>
<legend><&|/l&>please_fill_out_this_form</&></legend>
<table>
% foreach my $t ( @text_f ) {
<% form_row( $t, $t, "text", $ARGS{$t}, $errs{$t} ) %>
% }
<% form_row( "passwd", "password", "password", $ARGS{password}, $errs{password} ) %> 
<% form_row( "passwd", "password2", "password", "", $errs{password2} ) %> 
<tr>
<td><&|/l&>language</&>:</td>
<td>
<& /w, w => 'langselect' &>
</td></tr>
<tr>
<td><&|/l&>public</&></td>
<td>
% my $yc = $ARGS{public} eq 'yes' ? ' checked="checked"' : '';
% my $nc = $ARGS{public} eq 'no' ? ' checked="checked"' : '';
<&|/l&>yes</&><input type="radio" name="public" value="yes"<% $yc %>>
<&|/l&>no</&><input type="radio" name="public" value="no"<% $nc %>>
</td></tr>
</table>
</fieldset>
<br/>
<input type="submit" name="submit" value="<&|/l&>submit</&>"/>
</form>
%}
<%init>
  my $cur_lang = $spoejs{lang_handle}->{lang_order}->[0];

  my @text_f = qw ( shortname title description theme username );
  my @non_text_f = qw( language password public );
  my %errs;
  my $SC = new Spoejs::SiteConf( path => "$ENV{DOCUMENT_ROOT}/../lib",
                                 lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $SC->{msg} if $SC->{msg};

  my $policy = $SC->get( 'policy' );

# Load data if channel exists
if ( -d $spoejs{channel_path} && !$ARGS{submit} )
{
  # XXX: What goes on when adding 'lang' here? (~nothing is returned in get()
  my $CC = new Spoejs::ChannelConf( path => $spoejs{channel_path},
                                    lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $CC->{msg} if $CC->{msg};

  %ARGS = ( %ARGS, $CC->get() );
}

if ( $ARGS{submit} ) {

  check_args( \%ARGS, \%errs );

  # Pick appropriate args from %ARGS
  my %cl_args;
  $cl_args{$_}{$cur_lang} = $ARGS{$_} for ( @text_f, @non_text_f );

  # Overwrite 'shortname'
  $cl_args{shortname} = $ARGS{shortname};

  # Add 'active' based on site policy
  $cl_args{active} = $policy eq 'signup' ? 'no' : 'yes';

  # Create new channel if there were no errors

  if ( keys %errs == 0 && !$spoejs{channel} ) {

    my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/" );

    my $res = $CL->new_channel( %cl_args );
    $spoejs{error}{new_chan} = $CL->{msg} unless $res;

    # Start as logged in when you have just signed up
    $session{chanauth}{$cl_args{shortname}} = 1;

  } elsif (  keys %errs == 0 && $spoejs{channel} ) {

    my $CC = new Spoejs::ChannelConf( path => $spoejs{channel_path},
                                      lang => $spoejs{lang_handle} );
    $spoejs{error}{$m->current_comp->source_file} = $CC->{msg} if $CC->{msg};

    my $res = $CC->set( %cl_args );
  }


}
</%init>
<%perl>
sub form_row {
  my ( $text, $name, $type, $val, $err ) = @_;
  $text = $m->comp( "/l", l => $text );
  return <<HTML;
<tr>
  <td>$text:</td>
  <td><input value="$val" type="$type" name="$name">$err</td>
</tr>
HTML
}

sub check_args {
  my ( $ARGS, $errs ) = @_;

  # XXX: Add checks on rest of input!!!
  unless ( $$ARGS{shortname} =~ /^[a-z]{4,10}$/ ) {
    $$errs{shortname} = " Only 4-10 letters from a-z";
  }
  if ( -d "$ENV{DOCUMENT_ROOT}/users/$$ARGS{shortname}" and !$spoejs{channel}) {
    $$errs{shortname} = " Channel already exists";
  }
  unless ( $$ARGS{language} =~ /^[a-z]{2}$/ ) {
    $$errs{language} = " Only 2 letters (eg. 'da' or 'en')";
  }
  unless ( $$ARGS{public} =~ /^yes$|^no$/ ) {
    $$errs{public} = " Only yes/no";
  }
  unless ( $$ARGS{password} eq $$ARGS{password2} ) {
    $$errs{password} = $$errs{password2} = " Passwords does not match";
  }
}

sub check_cred {
 my $policy = shift;
 if ( defined $spoejs{channel} ) {

   # We are editing current channel check if we are permitted
   return undef unless $m->comp( 'checkLogin.html' );

 } elsif (  $policy eq 'invite' and !$session{siteauth} ) {

   # New channels can be made with siteauth creds or ffa/signup policy 
   return undef;
 }

  return 1;
}
</%perl>
