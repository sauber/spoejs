<& /w, w => 'media-page',
      ML => $ML,
      S  => $S,
      back_href => $back_href,
      next_href => $next_href,
      prev_href => $prev_href,
      img_href  => $img_href,
      img_src  => $img_src,
      filename  => $filename,
&>
<%init>
my $web_path = "/users/$spoejs{channel}/$spoejs{p}{d}";
my $path = "$ENV{DOCUMENT_ROOT}$web_path";

my $ML = new Spoejs::MediaList( path => $path );
$spoejs{error}{$m->current_comp->source_file} = $ML->{msg} if $ML->{msg};

my $S = new Spoejs::Story( path => $path, lang => $spoejs{lang_handle} );
$spoejs{error}{$m->current_comp->source_file} = $S->{msg} if $S->{msg};

my %ml_opt = ( current => $spoejs{p}{p}, count => 2 );

my $next_href;
my @p = $ML->next( %ml_opt );
if ( $p[1] ) {
  $next_href = $m->scomp( '/htm/url:encode', "media.html", d=>$spoejs{p}{d},
			   p=> $p[1]->{file} );
}
my $prev_href;
@p = $ML->prev( %ml_opt );
if ( $p[1] ) {
  $prev_href = $m->scomp( '/htm/url:encode', "media.html", d=>$spoejs{p}{d},
			   p=> $p[1]->{file} );
}
my $back_href = $m->scomp( "url:encode", 'story.html', d => $spoejs{p}{d} );
my $img_href  = "$web_path/$spoejs{p}{p}";
my $img_src   = $m->scomp( '/w', w => "media", d => $spoejs{p}{d}, 
			  p => $spoejs{p}{p}, m => 480 );

my $picref    = $ML->get_picref($spoejs{p}{p}) 
  or $spoejs{error}{$m->current_comp->source_file} = $ML->{msg};
my $filename  = $picref->utf_filename();
</%init>