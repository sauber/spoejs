<%doc>
login, authenticate, logout

License: Artistic License
         http://www.opensource.org/licenses/artistic-license.php

$Id: login.html,v 1.9 2004/06/12 09:40:13 snicki Exp $
</%doc>
% if ( $ARGS{login} ) {
%  # List authorized channels
<h2>**authorized_for**:</h2><ul>
%  for my $chan ( keys %{$session{chanauth}} ) {
<li><a href="/<%$chan%>/index.html"><% $chan %></a></li>
%  }
</ul>
% }
<& /w, w => "login", ses_var => 'chanauth' &>
%if ( $show_signup ) {
<a href="/htm/admin/signup.html">**new_account**</a>
% }
<%init>
if ( $login ) {

  # Check authorized channels
  my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/",
                                    lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $CL->{msg} if $CL->{msg};

  my @channels;
  @channels = $CL->search_channels( username => $username,
	                            password => $password ) unless $CL->{msg};
  @channels = () if $channels[0] eq undef;

  for my $c ( @channels ) {
    my $sn = $c->get( 'shortname' );
    $session{chanauth}{$sn} = 1;
  }

  # Check site auth
  # '**sa**' is not an allowed channel name so this should be safe
  my $p = $spoejs{SiteConf}->get( 'password' );
  my $u = $spoejs{SiteConf}->get( 'username' );
  $session{chanauth}{'**sa**'} = $username if $username eq $u and $password eq $p;

} elsif ( $logout ) {

  delete $session{chanauth};
  $m->print( '**you_have_been_logged_out**' );
}

my $policy = $spoejs{SiteConf}->get( 'policy' );
my $show_signup;
if ( ( $policy eq 'freeall' or $policy eq 'signup_approve') ) {
  $show_signup = 1;
}
</%init>
<%method check_login>
<%perl>
unless ( defined $spoejs{channel} && defined $session{chanauth} &&
         defined $session{chanauth}{$spoejs{channel}} ) {
  $m->print( '**pleaselogin**' );
  return undef; 
} else { 
  return 1;
}
</%perl>
</%method>
<%args>
$username => undef
$password => undef
$login    => undef
$logout   => undef
</%args>
