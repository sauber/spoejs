<%doc>
login, authenticate, logout

License: Artistic License
         http://www.opensource.org/licenses/artistic-license.php

$Id: login.html,v 1.12 2004/06/13 06:50:30 snicki Exp $
</%doc>
% if ( defined $session{chanauth} ) {
%  # List authorized channels
<&| /w, w => 'box', heading => '**authorized_for**' &>
<ul>
%  for my $chan ( @authorized ) {
<li><a href="<% $chan->[1] %>"><% $chan->[0] %></a></li>
%  }
</ul>
</&>
<br/>
% }
<& /w, w => "login", ses_var => 'chanauth', box => 1 &>
%unless ( defined $session{chanauth} ) {
%if ( $show_signup ) {
<br/><a href="/htm/admin/signup.html">**new_account**</a>
% }}
<& /htm/debug.html &>
<%init>
if ( $login ) {

  # Check authorized channels
  my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/",
                                    lang => $spoejs{lang_handle} );
  $spoejs{error}{$m->current_comp->source_file} = $CL->{msg} if $CL->{msg};

  my @channels;
  @channels = $CL->search_channels( username => $username,
	                            password => $password ) unless $CL->{msg};
  @channels = () if $channels[0] eq undef;

  for my $c ( @channels ) {
    my $sn = $c->get( 'shortname' );
    $session{chanauth}{$sn} = 1;
  }

  # Check site auth
  # '**sa**' is not an allowed channel name so this should be safe
  my $p = $spoejs{SiteConf}->get( 'password' );
  my $u = $spoejs{SiteConf}->get( 'username' );
  $session{chanauth}{'**sa**'} = $username if $username eq $u and $password eq $p;

# Prepare error for fill_in_form
 delete $session{form_error}{login_form};
 unless ( defined $session{chanauth} ) {
   $session{form_error}{login_form}{username} = '**wrong_user_or_pwd**';
 }
} elsif ( $logout ) {

  delete $session{chanauth};
  $m->print( '**you_have_been_logged_out**' );
}

# Prepare list of authorized channels
my @authorized;
if ( defined $session{chanauth} ) {
  my $siteconfig = '/htm/admin/siteconfig.html';
  for my $chan ( keys %{$session{chanauth}} ) {
    if ( $chan =~ /^\*\*sa\*\*$/ ) {
       push @authorized, [ $chan, $siteconfig ];
    } else {
       push @authorized, [ $chan, "/$chan/index.html" ];
    }
  }

  # Go directly to page if we are authorized for only one "function"
  $m->redirect( $authorized[0]->[1] ) if @authorized == 1 && $login;
}

my $policy = $spoejs{SiteConf}->get( 'policy' );
my $show_signup;
if ( ( $policy eq 'freeall' or $policy eq 'signup_approve') ) {
  $show_signup = 1;
}
</%init>
<%method check_login>
<%perl>
unless ( defined $spoejs{channel} && defined $session{chanauth} &&
         defined $session{chanauth}{$spoejs{channel}} ) {
  $m->print( '**pleaselogin**' );
  return undef; 
} else { 
  return 1;
}
</%perl>
</%method>
<%args>
$username => undef
$password => undef
$login    => undef
$logout   => undef
</%args>
