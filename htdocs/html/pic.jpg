<% $$picref %>
% $m->abort();
<%init>
    use Spoejs::Pic;
    my $path = "$ENV{DOCUMENT_ROOT}/users/$session{user}";
    my $story_path = $$params{d};
    $story_path =~ s{(....)(..)(..)}{/$1/$2/$3};
    $path .= $story_path;
    my $P = Spoejs::Pic->new( path => $path );

    # Add '.' to filename parameter
    my $file = $$params{p};
    $file =~ s{(.*)(...)}{$1\.$2};
    my $picref = $P->get( file => $file, size => $$params{m} );

    # Make sure we only send out jpeg data
    $m->clear_buffer();
    $r->content_type('image/jpeg');
    # Caching
    my $offset = 60 * 60 * 24 * 60; # seconds * minutes * hours * days
    my $e = gmtime( time + $offset );
    my $l = gmtime( time - $offset * 10 );
    $r->headers_out->add( "Expires" => $e );
    $r->headers_out->add( "Last-Modified" => $l );
</%init>
<%args>
 $params => undef    
</%args>