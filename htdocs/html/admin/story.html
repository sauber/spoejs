% return unless $m->comp( 'checkLogin.html' );
%# XXX: Do we need an author field?

% if ( $ARGS{submit} ) {
<h4>Story saved successfully.</h4>
<a href="/<% $session{user} %>/admin/upload_d<% $story_url %>.html">
Click here to add media to story.
</a>
% return; }

<h4>Editing for language: <% $cur_lang %></h4>

<form action="" method="post">
Your name:<br/>
<input type="text" size="60" name="author" value="<%$ARGS{author}%>"/><br/>
Story title:<br/>
<input type="text" size="60" name="title" value="<%$ARGS{title}%>"/><br/>
Date: (leave blank if story is current)<br/>
<input type="text" size="60" name="date" value="<%$ARGS{date}%>"/><br/>
Category:<br/>
%#<select name="category">
%#<option value="">Please select</option>
%#</select>
%#or new: 
<input type="text" size="30" name="category" value=""/><br/>
Story abstract:<br/>
<textarea name="abstract" rows="5" cols="60"><%$ARGS{abstract}%></textarea>
<br/>
Full story text:<br/>
<textarea name="fulltext" rows="20"
cols="60"><%$ARGS{fulltext}%></textarea>
<br/>
<input type="submit" name="submit" value="Submit"/>
</form>

<a href="/<% $session{user} %>/admin/upload_d<% $story_url %>.html">
Click here to add media to existing story.
</a>

%#<pre>
%#<% Dumper %params %>
%#<% Dumper %ARGS %>
%#<% Dumper $cur_lang %>
%#</pre>
<%init>

my $cur_lang = $spoejs{lang_handle}->{lang_order}->[0];
my @entries = qw( title date category abstract fulltext author );

my $chan_path = "$ENV{DOCUMENT_ROOT}/users/$session{user}";
$params{d} =~ s{(\d{4})(\d\d)(\d\d)}{$1/$2/$3}g if $params{d};

my $SL = Spoejs::StoryList->new( path => $chan_path,
                                 lang => $spoejs{lang_handle} );

my $story_dir = $params{d} || undef;
my $S;

# Get data from existing story or create new story
if ( $params{d} && -d "$chan_path/$params{d}" && !$ARGS{submit} ) {

  $S = new Spoejs::Story( path => "$chan_path/$params{d}",
                          lang => $spoejs{lang_handle} );

  # Add data to args
  %ARGS = ( %ARGS, $S->get() );
}


if ( $ARGS{submit} ) {

  # Create new story if necessary
  unless ( $story_dir && -d "$chan_path/$story_dir" ) {
    $story_dir = $SL->add_story( date => $ARGS{date} );
  }

  $S = new Spoejs::Story( path => "$chan_path/$story_dir",
                          lang => $spoejs{lang_handle} );

# XXX: Verify input

# Save to story
my %new_data;
for ( @entries ) {
  $new_data{$_}{$cur_lang} = $ARGS{$_};
}

$S->set( %new_data );
}

my $story_url = $story_dir;
$story_url =~ s{/}{}g;
</%init>
<%args>
  %params => undef
</%args>