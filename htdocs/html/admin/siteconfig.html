<h1>Status for channels at this site:</h1>
<& /w, w => "login", action => '', ses_var => 'siteauth' &>
% return unless ( $session{siteauth} );
<form method="post" action="">
<table width="100%">
<tr>
<th>Shortname</th><th>Title</th><th>Public</th>
<th>Active</th><th>Archive</th><th>Delete</th>
</tr>
% foreach my $chan ( @channels ) {
<tr>
<td><% $chan->get( 'shortname' ) %></td>
<td><a href="/<% $chan->channel_dir() %>/index.html">
<% $chan->get( 'title' ) %></a>
</td>
<td align="center"><% $chan->get( 'public' ) %></td>
<td align="center">
<select name="<% $chan->get( 'shortname' ) %>">
% while ( my ( $k, $v ) = each %yn ) {
<option value="<% $k %>"<% $chan->get( 'active' ) eq $k ? 
                                               ' selected="selected">' : '>' %>
<%$v %>
</option>
% }
</select>
</td>
%# Archive
<td>
<input type="submit" name="archive" value="<% $chan->get( 'shortname' ) %>"/>
</td>
%# Delete
<td>
<input type="submit" name="delete" value="<% $chan->get( 'shortname' ) %>"/>
</td>
</tr>
% }
</table>
<br/>
Site policy:
<select name="policy">
% foreach my $pol ( sort keys %policy ) {
 <option value="<% $pol %>"<% $SC->get( 'policy' ) eq $pol ? 
                              ' selected="selected">' : '>' %>
<%$policy{$pol}%></option>
% }
</select>
<br/>
<br/>
<input type="submit" name="submit" value="Submit" />
</form>

<%init>

my %yn = ( yes => 'Yes', no => 'No' );

my %policy = ( ffa => 'Free-for-all', signup => 'Signup-Approve',
               invite => 'Invite-only' );

my $SC = new Spoejs::SiteConf( path => "$ENV{DOCUMENT_ROOT}/../lib",
                               lang => $spoejs{lang_handle} );

if ( $ARGS{login} ) {

  my $p = $SC->get( 'password' );
  my $u = $SC->get( 'username' );
  $session{siteauth} = 1 if $ARGS{username} eq $u and $ARGS{password} eq $p;

} elsif ( $ARGS{logout} ) {

  delete $session{siteauth};
} 

my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/",
                                  lang => $spoejs{lang_handle} );

# Delete and archive before getting channel list
if ( $ARGS{delete} ) {

  $CL->delete_channel( $ARGS{delete} ) or warn $CL->{msg};
} 

if ( $ARGS{archive} ) {

  $CL->archive_channel( $ARGS{archive} );
}

# Get array of ChannelConf object refs
my @channels = $CL->search_channels();

# Set the new status
if ( $ARGS{submit} ) {

  foreach my $chan ( @channels ) {
    $chan->set( active => $ARGS{$chan->get('shortname')} );
  }

  # Set new policy
  $SC->set( policy => $ARGS{policy} ) or warn $SC->{msg};
} 
</%init>
