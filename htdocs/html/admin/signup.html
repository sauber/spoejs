%if ( $ARGS{login} && keys %errs == 0 ) {
<h2>Congratulations you are now signed up for a Spoejs channel</h2>
<a href="/<%$ARGS{shortname}%>/index.html">Click here to continue</a>
% } else {
<form method="post">
<table>
% foreach my $t ( @text_f ) {
<% form_row( $t, $t, "text", $ARGS{$t}, $errs{$t} ) %>
% }
<% form_row( "passwd", "password", "password", "", $errs{password} ) %> 
<% form_row( "passwd", "password2", "password", "", $errs{password2} ) %> 
<tr>
  <td><input type="submit" name="login" value="<&|/l&>signup</&>"/></td>
</tr>
</table>
</form>
%}
<%init>
  # XXX: Change 'input' types for 'public', 'language' etc.

my @text_f = qw ( shortname title description language theme public username );
my $succes = undef;
my %errs;

if ( $ARGS{login} ) {

  # XXX: Add checks on rest of input!!!
  unless ( $ARGS{shortname} =~ /^[a-z]{4,10}$/ ) {
    $errs{shortname} = " Only 4-10 letters from a-z";
  }
  unless ( $ARGS{language} =~ /^[a-z]{2}$/ ) {
    $errs{language} = " Only 2 letters (eg. 'da' or 'en')";
  }
  unless ( $ARGS{public} =~ /^[yn]$/ ) {
    $errs{public} = " Only y/n";
  }
  unless ( $ARGS{password} eq $ARGS{password2} ) {
    $errs{password} = $errs{password2} = " Passwords does not match";
  }

  if ( keys %errs == 0 ) {
    my $CL = new Spoejs::ChannelList( path => "$ENV{DOCUMENT_ROOT}/users/" );
    my %cl_args;
    @cl_args{ @text_f, 'password' } = @ARGS{ @text_f, 'password' };
    my $res = $CL->new_channel( %cl_args );
  }
}

sub form_row {
  my ( $text, $name, $type, $val, $err ) = @_;
  $text = $m->comp( "/l", l=>$text );
my $html = <<HTML;
<tr>
  <td>$text:</td>
  <td><input value="$val" type="$type" name="$name">$err</td>
</tr>
HTML
}

</%init>
